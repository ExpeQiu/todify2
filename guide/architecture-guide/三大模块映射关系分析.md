# 三大模块映射关系分析文档

## 概述

本文档详细分析Todify平台三大核心工作流模块的字段映射关系，基于最新的代码实现进行全面更新，确保字段映射表准确反映实际系统配置。

**最后更新时间**: 2024年1月
**代码版本**: 基于当前生产环境实现

## 1. IP挖掘工作流 (IP_MINING)

### 1.1 字段映射关系

**实现位置**: `api/services/WorkflowService.ts` 第53-120行

| 前端字段 | 内部标准字段 | Dify字段 | 字段类型 | 是否必需 | 描述 |
|---------|-------------|----------|----------|----------|--------|
| techContent | tech_content | tech_content | textarea | 是 | 技术内容描述 |
| techDomain | tech_domain | tech_domain | select | 是 | 技术领域 |
| techMaturity | tech_maturity | tech_maturity | select | 是 | 技术成熟度 |
| brand | brand | brand | select | 是 | 汽车品牌 |
| targetConsumer | target_consumer | target_consumer | select | 是 | 目标消费人群 |

### 1.2 验证规则

根据WorkflowService.validateWorkflowInputs方法实现：

- **tech_content**: 必需字段，技术内容描述
- **tech_domain**: 必需字段，技术领域
- **tech_maturity**: 必需字段，技术成熟度
- **brand**: 必需字段，汽车品牌
- **target_consumer**: 必需字段，目标消费人群

### 1.3 数据库配置

**配置位置**: `migration-to-optimized.sql` 第75-120行

字段映射在数据库中的配置包括frontend_field、internal_field、dify_field等映射关系。

## 2. 技术通稿撰写工作流 (TECH_ARTICLE)

### 2.1 字段映射关系

**实现位置**: `api/services/TechArticleFieldMappingService.ts`

| 前端字段 | 内部标准字段 | Dify字段 | 字段类型 | 是否必需 | 验证规则 | 描述 |
|---------|-------------|----------|----------|----------|----------|--------|
| techTopic | techTopic | techTopic | text | 是 | 长度1-100 | 技术主题 |
| vehicleModel | vehicle_model | vehicle_model | text | 是 | 长度1-50 | 车型名称 |
| techContent | tech_content | tech_content | textarea | 是 | 长度10-5000 | 技术内容 |
| techPlatform | tech_Plat | tech_Plat | text | 是 | 长度1-100 | 技术平台 |
| highlightTech | Highlight_tech | Highlight_tech | textarea | 是 | 长度1-1000 | 突出技术点 |
| associateTech | Associate_tech | Associate_tech | textarea | 是 | 长度1-1000 | 关联技术 |

### 2.2 验证规则详情

**必需字段列表** (第108-120行):
```typescript
[
  'techTopic',
  'vehicleModel', 
  'techContent',
  'techPlatform',
  'highlightTech',
  'associateTech'
]
```

### 2.3 服务接口

- `validateInput()`: 输入验证
- `mapToWorkflowInput()`: 前端到Dify字段映射
- `mapFromWorkflowOutput()`: Dify到前端字段映射
- `cleanAndNormalizeInput()`: 数据清理和标准化

## 3. 演讲稿撰写工作流 (SPEECH_WRITING)

### 3.1 字段映射关系

**实现位置**: `api/services/SpeechWritingFieldMappingService.ts`

| 前端字段 | 内部标准字段 | Dify字段 | 字段类型 | 是否必需 | 验证规则 | 描述 |
|---------|-------------|----------|----------|----------|----------|--------|
| originalContext | original_context | original_context | textarea | 是 | 长度10-5000 | 原始内容 |
| leaderName | leader_name | leader_name | text | 是 | 长度1-50 | 领导姓名 |
| speechDuration | speech_duration | speech_duration | select | 是 | 预设选项 | 演讲时长 |
| audienceType | audience_type | audience_type | select | 是 | 预设选项 | 受众类型 |
| publishType | publish | publish | select | 是 | 预设选项 | 发布类型 |
| carBrand | car_brand | car_brand | text | 是 | 长度1-50 | 汽车品牌 |
| keyTechnology | key_tech | key_tech | text | 是 | 长度1-200 | 关键技术 |

### 3.2 字段选项配置

#### 演讲时长 (speech_duration)
```json
["10分钟", "20分钟", "30分钟"]
```

#### 受众类型 (audience_type)
```json
["媒体记者", "经销商", "终端消费者", "综合受众"]
```

#### 发布类型 (publish_type)
```json
["新产品发布会", "新技术发布会", "全新平台发布会"]
```

### 3.3 必需字段列表

**配置位置**: 第100-130行
```typescript
[
  'originalContext',
  'leaderName',
  'speechDuration', 
  'audienceType',
  'publishType',
  'carBrand',
  'keyTechnology'
]
```

### 3.4 服务接口

- `validateInput()`: 输入验证，支持详细的错误和警告信息
- `mapToWorkflowInput()`: 前端到Dify字段映射
- `mapFromWorkflowOutput()`: Dify到前端字段映射  
- `cleanAndNormalizeInput()`: 数据清理和标准化
- `generateMappingSummary()`: 生成映射摘要

## 4. 统一映射关系管理

### 4.1 字段映射服务架构

1. **IP挖掘模块**: 使用WorkflowService中的通用映射逻辑
2. **技术通稿模块**: 专用TechArticleFieldMappingService服务
3. **演讲稿撰写模块**: 专用SpeechWritingFieldMappingService服务

### 4.2 命名规范

- **前端字段**: 驼峰命名法 (camelCase)
- **内部字段**: 下划线命名法 (snake_case) 
- **Dify字段**: 与内部字段保持一致

### 4.3 验证规范

- 必需字段验证
- 字段长度限制
- 选项值验证
- 数据类型验证

## 5. 代码实现差异分析

### 5.1 主要发现

1. **IP挖掘模块**: 实际使用target_consumer而非文档中的Aim_co
2. **技术通稿模块**: 所有字段都是必需的，与原文档不符
3. **演讲稿撰写模块**: 字段验证规则更加严格，包含详细的长度限制

### 5.2 服务实现状态

- ✅ **演讲稿撰写**: 完整的专用服务实现
- ✅ **技术通稿**: 完整的专用服务实现  
- ⚠️ **IP挖掘**: 使用WorkflowService通用逻辑，建议创建专用服务

## 6. 建议和改进

### 6.1 短期改进

1. 为IP挖掘模块创建专用的FieldMappingService
2. 统一三个模块的服务接口规范
3. 完善字段验证规则的文档化

### 6.2 长期规划

1. 建立统一的字段映射管理框架
2. 实现动态字段配置能力
3. 增强多语言支持
4. 完善监控和审计功能

---

**文档维护**: 本文档应与代码实现保持同步，建议每次字段映射变更后及时更新。