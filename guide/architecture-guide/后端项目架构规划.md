# 后端项目架构规划

## 项目概述

基于前端与Dify工作流字段对比分析，设计一个统一的后端架构，实现前端和Dify工作流的双重对接，建立灵活的映射关系和完善的数据管理系统。

## 1. 架构设计原则

### 1.1 核心原则
- **统一数据模型**：建立标准化的内部数据结构
- **灵活映射机制**：支持动态字段映射和验证
- **多工作流支持**：同时支持多个Dify工作流
- **可扩展性**：便于添加新的工作流和字段
- **数据一致性**：确保前端、后端、Dify之间的数据一致

### 1.2 分层架构
```
┌─────────────────┐
│   前端应用层     │
└─────────────────┘
         │
┌─────────────────┐
│   API接口层     │  ← 统一的RESTful API
└─────────────────┘
         │
┌─────────────────┐
│   业务逻辑层     │  ← 工作流管理、数据转换
└─────────────────┘
         │
┌─────────────────┐
│   数据访问层     │  ← 数据库操作、缓存
└─────────────────┘
         │
┌─────────────────┐
│   外部服务层     │  ← Dify API对接
└─────────────────┘
```

## 2. 统一数据模型设计

### 2.1 核心实体模型

#### 工作流定义 (WorkflowDefinition)
```typescript
interface WorkflowDefinition {
  id: string;
  name: string;
  type: 'speech_writing' | 'ip_mining' | 'tech_article';
  difyWorkflowId: string;
  version: string;
  isActive: boolean;
  fieldMappings: FieldMapping[];
  validationRules: ValidationRule[];
  createdAt: Date;
  updatedAt: Date;
}
```

#### 字段映射 (FieldMapping)
```typescript
interface FieldMapping {
  id: string;
  workflowId: string;
  frontendField: string;      // 前端字段名
  internalField: string;      // 内部标准字段名
  difyField: string;          // Dify工作流字段名
  fieldType: 'text' | 'textarea' | 'select' | 'number' | 'boolean';
  isRequired: boolean;
  defaultValue?: any;
  options?: SelectOption[];   // 选择项配置
  validation: FieldValidation;
}
```

#### 任务实体 (Task)
```typescript
interface Task {
  id: string;
  workflowType: string;
  workflowId: string;
  userId?: string;
  inputData: Record<string, any>;     // 标准化的输入数据
  outputData?: Record<string, any>;   // 工作流输出数据
  status: 'pending' | 'running' | 'completed' | 'failed' | 'cancelled';
  progress: number;
  currentNode?: string;
  errorMessage?: string;
  difyTaskId?: string;
  processingTime?: number;
  createdAt: Date;
  updatedAt: Date;
  completedAt?: Date;
}
```

### 2.2 字段标准化

#### 通用字段定义
```typescript
// 标准化的内部字段名
const STANDARD_FIELDS = {
  // 基础信息
  CONTENT: 'content',                    // 主要内容
  TITLE: 'title',                        // 标题
  DESCRIPTION: 'description',            // 描述
  
  // 人员信息
  LEADER_NAME: 'leader_name',            // 领导姓名
  USER_NAME: 'user_name',                // 用户姓名
  
  // 时间相关
  DURATION: 'duration',                  // 时长
  DEADLINE: 'deadline',                  // 截止时间
  
  // 分类信息
  CATEGORY: 'category',                  // 类别
  TYPE: 'type',                          // 类型
  BRAND: 'brand',                        // 品牌
  PLATFORM: 'platform',                 // 平台
  
  // 受众信息
  AUDIENCE_TYPE: 'audience_type',        // 受众类型
  TARGET_GROUP: 'target_group',          // 目标群体
  
  // 技术相关
  TECHNOLOGY: 'technology',              // 技术
  TECH_FIELD: 'tech_field',             // 技术领域
  TECH_MATURITY: 'tech_maturity',       // 技术成熟度
  
  // 发布相关
  PUBLISH_TYPE: 'publish_type',          // 发布类型
  PUBLISH_CHANNEL: 'publish_channel',    // 发布渠道
  
  // 补充信息
  ADDITIONAL_INFO: 'additional_info',    // 补充说明
  NOTES: 'notes',                        // 备注
  TAGS: 'tags'                           // 标签
} as const;
```

## 3. 数据库Schema设计

### 3.1 扩展的Prisma Schema

```prisma
// 工作流定义表
model WorkflowDefinition {
  id              String   @id @default(cuid())
  name            String
  type            String   // 'speech_writing' | 'ip_mining' | 'tech_article'
  difyWorkflowId  String   @map("dify_workflow_id")
  version         String   @default("1.0.0")
  isActive        Boolean  @default(true) @map("is_active")
  description     String?
  config          String   // JSON配置
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  fieldMappings   FieldMapping[]
  tasks          Task[]
  
  @@map("workflow_definitions")
  @@unique([type, version])
  @@index([type, isActive])
}

// 字段映射表
model FieldMapping {
  id              String   @id @default(cuid())
  workflowId      String   @map("workflow_id")
  frontendField   String   @map("frontend_field")
  internalField   String   @map("internal_field")
  difyField       String   @map("dify_field")
  fieldType       String   @map("field_type")
  isRequired      Boolean  @default(false) @map("is_required")
  defaultValue    String?  @map("default_value")
  options         String?  // JSON数组
  validation      String?  // JSON验证规则
  order           Int      @default(0)
  createdAt       DateTime @default(now()) @map("created_at")
  
  workflow        WorkflowDefinition @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  
  @@map("field_mappings")
  @@unique([workflowId, frontendField])
  @@unique([workflowId, internalField])
  @@index([workflowId, order])
}

// 任务表 (扩展现有的AnalysisTask)
model Task {
  id              String   @id @default(cuid())
  workflowId      String   @map("workflow_id")
  workflowType    String   @map("workflow_type")
  userId          String?  @map("user_id")
  inputData       String   @map("input_data")      // JSON标准化输入
  outputData      String?  @map("output_data")     // JSON输出结果
  status          String   @default("pending")
  progress        Float    @default(0)
  currentNode     String?  @map("current_node")
  errorMessage    String?  @map("error_message")
  difyTaskId      String?  @map("dify_task_id")
  processingTime  Int?     @map("processing_time")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  completedAt     DateTime? @map("completed_at")
  
  workflow        WorkflowDefinition @relation(fields: [workflowId], references: [id])
  results         TaskResult[]
  
  @@map("tasks")
  @@index([workflowType, status])
  @@index([userId, createdAt(sort: Desc)])
  @@index([status, createdAt(sort: Desc)])
}

// 任务结果表
model TaskResult {
  id              String   @id @default(cuid())
  taskId          String   @map("task_id")
  nodeId          String?  @map("node_id")
  nodeName        String?  @map("node_name")
  resultType      String   @map("result_type")     // 'intermediate' | 'final'
  resultData      String   @map("result_data")     // JSON结果数据
  metadata        String?  // JSON元数据
  createdAt       DateTime @default(now()) @map("created_at")
  
  task            Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@map("task_results")
  @@index([taskId, resultType])
  @@index([taskId, createdAt])
}

// 用户表 (可选)
model User {
  id              String   @id @default(cuid())
  email           String?  @unique
  name            String?
  avatar          String?
  preferences     String?  // JSON用户偏好
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("users")
}

// 系统配置表
model SystemConfig {
  id              String   @id @default(cuid())
  key             String   @unique
  value           String
  description     String?
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  @@map("system_configs")
}
```

### 3.2 数据迁移策略

1. **保留现有数据**：将现有的`AnalysisTask`数据迁移到新的`Task`表
2. **创建默认工作流**：为现有的演讲稿撰写功能创建默认工作流定义
3. **建立字段映射**：根据现有的`workflow-mapper.ts`创建初始字段映射

## 4. API接口层设计

### 4.1 RESTful API结构

```
/api/v1/
├── workflows/                 # 工作流管理
│   ├── GET    /               # 获取工作流列表
│   ├── GET    /:id            # 获取工作流详情
│   ├── POST   /               # 创建工作流
│   ├── PUT    /:id            # 更新工作流
│   └── DELETE /:id            # 删除工作流
│
├── workflows/:id/fields       # 字段映射管理
│   ├── GET    /               # 获取字段映射
│   ├── POST   /               # 创建字段映射
│   ├── PUT    /:fieldId       # 更新字段映射
│   └── DELETE /:fieldId       # 删除字段映射
│
├── tasks/                     # 任务管理
│   ├── GET    /               # 获取任务列表
│   ├── POST   /               # 创建任务
│   ├── GET    /:id            # 获取任务详情
│   ├── PUT    /:id            # 更新任务
│   ├── DELETE /:id            # 删除任务
│   ├── POST   /:id/start      # 启动任务
│   ├── POST   /:id/cancel     # 取消任务
│   └── GET    /:id/stream     # 任务流式输出
│
├── tasks/:id/results          # 任务结果
│   ├── GET    /               # 获取结果列表
│   └── GET    /:resultId      # 获取具体结果
│
└── system/                    # 系统管理
    ├── GET    /config         # 获取系统配置
    ├── PUT    /config         # 更新系统配置
    └── GET    /health         # 健康检查
```

### 4.2 核心API接口定义

#### 创建任务接口
```typescript
// POST /api/v1/tasks
interface CreateTaskRequest {
  workflowType: string;          // 工作流类型
  inputData: Record<string, any>; // 前端输入数据
  options?: {
    priority?: 'low' | 'normal' | 'high';
    timeout?: number;
    userId?: string;
  };
}

interface CreateTaskResponse {
  taskId: string;
  status: string;
  message: string;
  estimatedTime?: number;
}
```

#### 获取工作流字段接口
```typescript
// GET /api/v1/workflows/:id/fields
interface WorkflowFieldsResponse {
  workflowId: string;
  workflowName: string;
  fields: {
    frontendField: string;
    label: string;
    type: string;
    required: boolean;
    options?: Array<{value: string; label: string}>;
    validation?: {
      minLength?: number;
      maxLength?: number;
      pattern?: string;
    };
  }[];
}
```

## 5. 业务逻辑层设计

### 5.1 核心服务类

#### WorkflowService
```typescript
class WorkflowService {
  // 获取工作流定义
  async getWorkflowDefinition(type: string): Promise<WorkflowDefinition>
  
  // 获取字段映射
  async getFieldMappings(workflowId: string): Promise<FieldMapping[]>
  
  // 验证输入数据
  async validateInputData(workflowId: string, data: any): Promise<ValidationResult>
  
  // 数据转换：前端 -> 内部标准格式
  async transformFrontendData(workflowId: string, data: any): Promise<any>
  
  // 数据转换：内部标准格式 -> Dify格式
  async transformToDifyFormat(workflowId: string, data: any): Promise<any>
}
```

#### TaskService
```typescript
class TaskService {
  // 创建任务
  async createTask(workflowType: string, inputData: any): Promise<Task>
  
  // 启动任务
  async startTask(taskId: string): Promise<void>
  
  // 获取任务状态
  async getTaskStatus(taskId: string): Promise<TaskStatus>
  
  // 取消任务
  async cancelTask(taskId: string): Promise<void>
  
  // 处理任务结果
  async handleTaskResult(taskId: string, result: any): Promise<void>
}
```

#### MappingService
```typescript
class MappingService {
  // 动态字段映射
  async mapFields(mappings: FieldMapping[], sourceData: any): Promise<any>
  
  // 反向映射
  async reverseMapFields(mappings: FieldMapping[], targetData: any): Promise<any>
  
  // 验证字段
  async validateFields(mappings: FieldMapping[], data: any): Promise<ValidationResult>
  
  // 获取字段选项
  async getFieldOptions(fieldId: string): Promise<SelectOption[]>
}
```

### 5.2 数据转换流程

```
前端数据 → 标准化验证 → 内部格式 → Dify格式 → Dify API
    ↓           ↓          ↓         ↓
  验证规则   字段映射   数据转换   API调用
    ↓           ↓          ↓         ↓
  错误处理   缺失字段   类型转换   结果处理
```

## 6. 配置管理系统

### 6.1 工作流配置文件

```yaml
# workflows/speech-writing.yml
name: "汽车发布会演讲稿撰写助手"
type: "speech_writing"
difyWorkflowId: "your-dify-workflow-id"
version: "1.0.0"
description: "基于技术文件生成汽车发布会演讲稿"

fields:
  - frontend: "originalContext"
    internal: "content"
    dify: "original_context"
    type: "textarea"
    required: true
    validation:
      minLength: 10
      maxLength: 50000
    label: "技术文件"
    placeholder: "请输入或粘贴技术文件内容..."
    
  - frontend: "leaderName"
    internal: "leader_name"
    dify: "leader_name"
    type: "text"
    required: true
    validation:
      minLength: 1
      maxLength: 48
    label: "领导姓名"
    
  - frontend: "speechDuration"
    internal: "duration"
    dify: "speech_duration"
    type: "select"
    required: true
    options:
      - value: "10分钟"
        label: "10分钟"
      - value: "20分钟"
        label: "20分钟"
      - value: "30分钟"
        label: "30分钟"
    label: "演讲时长"
```

### 6.2 配置加载器

```typescript
class ConfigLoader {
  // 从文件加载配置
  async loadWorkflowConfig(filePath: string): Promise<WorkflowConfig>
  
  // 从数据库加载配置
  async loadWorkflowFromDB(workflowId: string): Promise<WorkflowDefinition>
  
  // 同步配置到数据库
  async syncConfigToDB(config: WorkflowConfig): Promise<void>
  
  // 验证配置
  async validateConfig(config: WorkflowConfig): Promise<ValidationResult>
}
```

## 7. 实施计划

### 7.1 第一阶段：基础架构 (1-2周)
1. 扩展数据库schema
2. 创建核心服务类
3. 实现基础的字段映射功能
4. 迁移现有数据

### 7.2 第二阶段：API接口 (1周)
1. 实现工作流管理API
2. 实现任务管理API
3. 更新现有的analysis路由
4. 添加字段映射管理API

### 7.3 第三阶段：配置系统 (1周)
1. 实现配置文件加载
2. 创建工作流配置管理界面
3. 实现动态字段映射
4. 添加配置验证

### 7.4 第四阶段：优化和测试 (1周)
1. 性能优化
2. 错误处理完善
3. 单元测试和集成测试
4. 文档完善

## 8. 技术栈

- **后端框架**: Express.js + TypeScript
- **数据库**: SQLite (开发) / PostgreSQL (生产)
- **ORM**: Prisma
- **验证**: Joi 或 Zod
- **配置**: YAML + JSON
- **缓存**: Redis (可选)
- **日志**: Winston
- **测试**: Jest + Supertest

## 9. 监控和日志

### 9.1 关键指标
- 任务创建成功率
- 任务执行时间
- 字段映射错误率
- API响应时间
- Dify API调用成功率

### 9.2 日志策略
- 请求日志：记录所有API请求
- 业务日志：记录关键业务操作
- 错误日志：记录所有错误和异常
- 性能日志：记录性能指标

## 10. 安全考虑

- **输入验证**: 严格的数据验证和清理
- **权限控制**: 基于角色的访问控制
- **数据加密**: 敏感数据加密存储
- **API限流**: 防止API滥用
- **审计日志**: 记录所有重要操作

这个架构设计提供了一个完整的解决方案，能够灵活地处理前端和Dify工作流之间的数据转换，同时支持多种工作流类型和动态配置。