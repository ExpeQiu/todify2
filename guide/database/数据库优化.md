# Todify2 数据库重新规划方案

## 一、现状分析

### 1.1 当前问题

- **表结构分散**：数据库表定义分散在11个SQL文件中，缺乏统一管理
- **表定义冲突**：`workflow_executions`表在`create-chat-tables.sql`和`create-agent-workflow-tables.sql`中重复定义，结构不一致
- **命名不规范**：主键类型不统一（TEXT vs INTEGER），字段命名风格不一致
- **索引分散**：索引定义分散在多个文件中，缺乏统一优化
- **外键不完整**：部分表缺少外键约束，数据完整性保障不足
- **缺乏版本管理**：没有数据库迁移机制

### 1.2 现有表分类

- **核心业务表**：brands, car_models, car_series, tech_categories, tech_points
- **AI生成内容表**：tech_packaging_materials, tech_promotion_strategies, tech_press_releases, tech_speeches
- **聊天对话表**：conversations, chat_messages, knowledge_points
- **工作流表**：agent_workflows, workflow_executions（冲突）, workflow_templates
- **配置表**：ai_roles, public_page_configs, page_tool_configs
- **统计表**：workflow_node_usage, ai_qa_feedback, workflow_session_stats等
- **文件表**：files

## 二、重新规划方案

### 2.1 数据库架构分层

#### 第一层：基础数据层

- **品牌车型体系**：brands → car_models → car_series
- **技术分类体系**：tech_categories（支持层级）
- **技术点体系**：tech_points（支持父子关系）

#### 第二层：关联关系层

- **技术点与车型关联**：tech_point_car_models
- **技术点与知识点关联**：tech_point_knowledge_points
- **AI内容与技术点关联**：promotion_tech_points, press_tech_points, speech_tech_points

#### 第三层：AI内容生成层

- **知识点管理**：knowledge_points, knowledge_point_favorites
- **AI生成内容**：tech_packaging_materials, tech_promotion_strategies, tech_press_releases, tech_speeches

#### 第四层：工作流与对话层

- **Agent工作流**：agent_workflows, workflow_templates
- **工作流执行**：workflow_executions（统一结构）
- **对话会话**：conversations, chat_messages
- **知识使用记录**：knowledge_usage_logs

#### 第五层：配置与统计层

- **AI角色配置**：ai_roles
- **页面配置**：public_page_configs, page_tool_configs
- **文件管理**：files
- **统计分析**：workflow_node_usage, ai_qa_feedback, workflow_session_stats, node_content_processing, workflow_stats_summary

### 2.2 关键优化点

#### 2.2.1 统一workflow_executions表

合并两个冲突的定义，设计统一的工作流执行表：

- 支持Agent工作流执行记录
- 支持Dify工作流执行记录
- 通过`execution_type`字段区分类型

#### 2.2.2 规范化命名

- **主键统一**：核心业务表使用INTEGER AUTOINCREMENT，配置表使用TEXT（UUID）
- **字段命名**：统一使用snake_case
- **表命名**：统一使用复数形式（如tech_points而非tech_point）

#### 2.2.3 完善外键约束

- 所有关联表添加外键约束
- 统一级联规则（CASCADE/SET NULL/RESTRICT）
- 添加必要的唯一约束

#### 2.2.4 索引优化

- 统一索引命名规范：`idx_表名_字段名`
- 创建复合索引优化常用查询
- 为外键字段自动创建索引

#### 2.2.5 添加系统表

- **database_migrations**：记录数据库迁移历史
- **system_configs**：系统配置表（可选）

## 三、实施步骤

### 步骤1：创建统一数据库架构文件

- 文件：`backend/src/scripts/unified-database-schema-v2.sql`
- 整合所有表定义，统一结构
- 解决workflow_executions表冲突
- 规范化命名和数据类型

### 步骤2：创建统一索引文件

- 文件：`backend/src/scripts/unified-database-indexes-v2.sql`
- 整合所有索引定义
- 优化复合索引
- 添加性能相关索引

### 步骤3：创建数据库迁移机制

- 文件：`backend/src/scripts/migrations/`目录
- 实现版本化的迁移脚本
- 创建migration记录表

### 步骤4：创建数据库初始化脚本

- 文件：`backend/src/scripts/init-database-v2.sh`
- 统一执行架构和索引脚本
- 支持SQLite和PostgreSQL

### 步骤5：更新相关代码

- 更新Model层代码以适配新表结构
- 更新Controller层代码
- 更新TypeScript类型定义

### 步骤6：数据迁移脚本（如需要）

- 创建数据迁移脚本，从旧结构迁移到新结构
- 备份现有数据

## 四、文件清单

### 新建文件

1. `backend/src/scripts/unified-database-schema-v2.sql` - 统一数据库架构
2. `backend/src/scripts/unified-database-indexes-v2.sql` - 统一索引定义
3. `backend/src/scripts/migrations/001_initial_schema.sql` - 初始迁移脚本
4. `backend/src/scripts/init-database-v2.sh` - 统一初始化脚本
5. `guide/database/database-design-v2.md` - 新版数据库设计文档

### 需要更新的文件

1. `backend/src/models/*.ts` - 更新Model以适配新结构
2. `backend/src/controllers/*.ts` - 更新Controller逻辑
3. `backend/src/config/database.ts` - 更新数据库配置

## 五、注意事项

1. **向后兼容**：确保新结构与现有代码兼容，或提供迁移路径
2. **数据备份**：执行迁移前必须备份现有数据
3. **测试验证**：在测试环境充分验证新架构
4. **文档更新**：同步更新API文档和开发文档
5. **性能测试**：验证索引优化后的查询性能

## 六、预期收益

1. **统一管理**：所有表结构集中管理，易于维护
2. **性能提升**：优化索引和查询，提升数据库性能
3. **数据完整性**：完善外键约束，保障数据一致性
4. **可扩展性**：规范化设计，便于后续扩展
5. **可维护性**：清晰的架构分层，降低维护成本