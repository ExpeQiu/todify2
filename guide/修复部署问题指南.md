# 修复Dify API 404错误指南

## 问题症状

浏览器控制台显示：
```
POST http://47.113.225.93:8088/api/dify 404 (Not Found)
```

## 根本原因

1. **前端配置缓存**：浏览器localStorage中缓存了旧的配置URL
2. **配置URL不完整**：缓存中的URL是 `http://47.113.225.93:8088/api/dify`，缺少 `/chat-messages` 后缀

## 解决方案

### 方案1：自动清除（已部署）

已更新 `configService.ts`，当检测到无效URL时会自动清除缓存并使用默认配置。

**清除后，请刷新浏览器页面**（Ctrl+Shift+R 或 Cmd+Shift+R 强制刷新）

### 方案2：手动清除

如果自动清除不起作用，请在浏览器控制台执行：

```javascript
localStorage.removeItem('difyConfigs');
localStorage.removeItem('workflowConfigs');
location.reload();
```

### 方案3：清除所有缓存

1. 打开浏览器开发者工具（F12）
2. 切换到 "Application" 或 "存储" 标签
3. 展开 "Local Storage"
4. 删除 `difyConfigs` 和 `workflowConfigs`
5. 刷新页面

## 验证修复

清除缓存后，检查浏览器控制台：

1. 应该看到：`⚠️ 检测到旧的无效配置，强制更新为正确配置`
2. URL应该是：`http://47.113.225.93:8088/api/dify/chat-messages`

## 正确的配置

### AI问答模型
- URL: `http://47.113.225.93:9999/v1/chat-messages`
- 通过代理访问：`http://47.113.225.93:8088/api/dify/chat-messages`

### 工作流模型（技术包装、策略、通稿、演讲稿）
- URL: `http://47.113.225.93:9999/v1/workflows/run`  
- 通过代理访问：`http://47.113.225.93:8088/api/dify/workflows/run`

## 部署后的操作

1. **刷新浏览器**：Ctrl+Shift+R（Windows）或 Cmd+Shift+R（Mac）
2. **清除浏览器缓存**：开发者工具 > Application > Clear storage
3. **验证配置**：检查控制台日志，确认URL正确

## 技术说明

### URL转换逻辑

```typescript
// 前端api.ts会自动转换：
http://47.113.225.93:9999/v1/chat-messages 
→ http://47.113.225.93:8088/api/dify/chat-messages

http://47.113.225.93:9999/v1/workflows/run
→ http://47.113.225.93:8088/api/dify/workflows/run
```

### 后端代理

Nginx (8088) → 后端服务 (3003) → Dify API (9999)

```
用户请求: 8088/api/dify/chat-messages
  ↓
Nginx代理: localhost:3003/api/dify/chat-messages
  ↓
后端处理: dify-proxy.ts
  ↓
Dify API: 9999/v1/chat-messages
```

## 已修复的文件

1. `backend/src/routes/dify-proxy.ts` - 修正Dify API端点URL
2. `backend/src/index.ts` - 添加 `0.0.0.0` 监听地址
3. `frontend/src/services/api.ts` - 修正URL转换逻辑  
4. `frontend/src/services/configService.ts` - 添加旧配置自动清除

## 服务状态检查

```bash
# 检查后端服务
curl http://47.113.225.93:8088/api/health

# 检查端口监听
netstat -tulnp | grep -E ':(3001|3003|8088)'
```

预期输出：
- 8088端口：Nginx监听
- 3003端口：后端服务监听
- 3001端口：前端服务监听


